(function(){"use strict";function d(t,e,n,s,r,o,c,R){var i=typeof t=="function"?t.options:t;e&&(i.render=e,i.staticRenderFns=n,i._compiled=!0),s&&(i.functional=!0),o&&(i._scopeId="data-v-"+o);var l;if(c?(l=function(a){a=a||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!a&&typeof __VUE_SSR_CONTEXT__<"u"&&(a=__VUE_SSR_CONTEXT__),r&&r.call(this,a),a&&a._registeredComponents&&a._registeredComponents.add(c)},i._ssrRegister=l):r&&(l=R?function(){r.call(this,(i.functional?this.parent:this).$root.$options.shadowRoot)}:r),l)if(i.functional){i._injectStyles=l;var C=i.render;i.render=function(N,h){return l.call(h),C(N,h)}}else{var u=i.beforeCreate;i.beforeCreate=u?[].concat(u,l):[l]}return{exports:t,options:i}}const p={data(){return{status:"loading",id:void 0,sendingTest:!1,errorDetailsList:[]}},computed:{allowedToSend(){return this.status==="draft"},canSend(){return this.allowedToSend},canSendTest(){return this.allowedToSend&&!this.sendingTest}},created(){this.load().then(t=>{this.status=t.status,this.id=t.id})},methods:{onSend(){if(this.$store.getters["content/hasChanges"]()){this.$panel.notification.error("√Ñnderungen m√ºssen vor dem Senden gespeichert oder verworfen werden.");return}this.$api.get(`${this.id}/check-send`).then(t=>{this.openDialog(t.data)}).catch(t=>{this.$panel.notification.error(t)})},openDialog(t=[]){this.$panel.dialog.open({component:"k-newsletter-send-dialog",props:{id:this.id,errorDetailsList:this.errorDetailsList,recipients:t.map(e=>({email:e.email,firstname:e.firstname,name:e.name})),canSubmit:t.length>0,text:"Den Newsletter an wirklich an alle Abonnenten senden?"},on:{submit:()=>{this.sendNewsletter()}}})},onSendTest(){if(this.$store.getters["content/hasChanges"]()){this.$panel.notification.error("√Ñnderungen m√ºssen vor dem Senden gespeichert oder verworfen werden.");return}this.sendTestNewsletter()},sendTestNewsletter(){if(!this.id){this.$panel.notification.error("Kein Newsletter zum versenden gefunden.");return}this.sendingTest=!0,this.$api.post(`${this.id}/send/1`).then(t=>{if(this.sendingTest=!1,t.data.successfulDelivery===0){this.$panel.notification.error("Keine Nachrichten versendet. Wurde mindestens ein Empf√§nger ausgew√§hlt?");return}if(t.data.errorDelivery>0){this.$panel.notification.error("Beim Senden an einzelne Empf√§nger ist ein Problem aufgetreten.");return}this.$panel.notification.success("Testmail gesendet")}).catch(t=>{this.sendingTest=!1,console.error(t),this.$panel.notification.error(t)})},sendNewsletter(){if(!this.id){this.$panel.notification.error("No newsletter found");return}this.$panel.dialog.isLoading=!0,this.$api.post(`${this.id}/send`).then(t=>{if(this.$panel.dialog.isLoading=!1,t.data.successfulDelivery===0){this.$panel.notification.error("Keine Nachrichten versendet. Wurde mindestens ein Empf√§nger ausgew√§hlt?");return}this.$panel.dialog.close(),this.$panel.reload()}).catch(t=>{this.$panel.dialog.isLoading=!1,console.error(t),this.$panel.notification.error(t)})}}};var f=function(){var e=this,n=e._self._c;return n("section",{staticClass:"k-newsletter-action-section"},[n("k-bar",[n("k-button-group",[n("k-button",{attrs:{variant:"filled",disabled:!e.canSendTest,icon:e.sendingTest?"loader":"lab"},on:{click:e.onSendTest}},[e._v(" Testmail senden ")]),n("k-button",{attrs:{variant:"filled",disabled:!e.canSend,icon:"plane"},on:{click:e.onSend}},[e._v(" Newsletter versenden ")])],1)],1)],1)},g=[],m=d(p,f,g,!1,null,null,null,null);const _=m.exports,v={inheritAttrs:!1,props:{headline:{type:String,default:"Newsletter versenden"},size:{type:String,default:"medium"},id:{type:String},recipients:{type:Array,default:()=>[]},canSubmit:{type:Boolean,default:!1}},emits:["cancel","submit","success"],data(){return{canSubmit:!0,detailsOpen:!0,recipientPage:1,recipientPageLimit:10}},computed:{visibleRecipientsForPage(){const t=this.recipients.slice((this.recipientPage-1)*this.recipientPageLimit,this.recipientPage*this.recipientPageLimit);return this.recipientPage>1&&t.length<this.recipientPageLimit&&t.push(...Array(this.recipientPageLimit-t.length).fill({})),t},total(){return this.recipients.length},isLoading(){return this.$panel.dialog.isLoading},submitButton(){return{disabled:!this.canSubmit||this.$panel.dialog.isLoading,text:"Versenden",icon:"plane"}}},methods:{}};var b=function(){var e=this,n=e._self._c;return n("k-dialog",{attrs:{"cancel-button":"Nicht senden",size:e.size,"submit-button":e.submitButton,visible:!0},on:{cancel:function(s){return e.$emit("cancel")},submit:function(s){return e.$emit("submit")}}},[e.headline?n("k-headline",[e._v(" "+e._s(e.headline)+" ")]):e._e(),n("k-stats",{staticStyle:{"margin-top":"1rem"},attrs:{reports:[{value:e.recipients.length,label:"Empf√§nger",icon:"users"}]}}),n("k-text",{staticStyle:{"margin-top":"1rem"}},[e._v("Liste aller Empf√§nger:")]),n("div",{staticClass:"k-table",staticStyle:{"margin-top":"1rem"}},[n("table",[n("thead",[n("tr",[n("th",{attrs:{"data-mobile":"true"}},[e._v("E-Mail")]),n("th",{attrs:{"data-mobile":"true"}},[e._v("Name")])])]),n("tbody",e._l(e.visibleRecipientsForPage,function(s){return n("tr",{key:s.email},[n("td",{attrs:{"data-mobile":"true"}},[e._v(e._s(s.email))]),n("td",{attrs:{"data-mobile":"true"}},[e._v(e._s(s.firstname)+" "+e._s(s.name))])])}),0)])]),n("k-pagination",{staticStyle:{"margin-top":".5rem"},attrs:{page:e.recipientPage,total:e.total,details:!0,limit:e.recipientPageLimit},on:{paginate:function(s){e.recipientPage=s.page}}})],1)},$=[],S=d(v,b,$,!1,null,null,null,null);const k=S.exports,w={data(){return{id:void 0,reports:[]}},computed:{canSendAll(){return this.reports.filter(t=>t.status==="error").length>0&&!this.isSending},errorReportsLength(){return this.reports.filter(t=>["error","sending"].includes(t.status)).length},successReportsLength(){return this.reports.filter(t=>t.status==="sent").length},isSending(){return this.reports.filter(t=>t.status==="sending").length>0},isSendingAll(){return!this.reports.some(t=>t.status==="error")&&this.reports.some(t=>t.status==="sending")}},created(){this.load().then(t=>{this.reports=t.reports,this.id=t.id})},methods:{resendSingle(t){return this.reports=this.reports.map(e=>e.email===t?{...e,status:"sending",statusicon:"üì§",info:"Wird gesendet..."}:e),this.$api.post(`${this.id}/send-single`,{email:t}).then(e=>{this.$panel.notification.success(`E-Mail an '${t}'' wurde erfolgreich versendet.`);const{status:n,statusicon:s,info:r}=e.data;this.reports=this.reports.map(o=>o.email===t?{...o,status:n,statusicon:s,info:r}:o)}).catch(e=>{console.error(e),this.$panel.notification.error(e),this.reports=this.reports.map(n=>{var s;return n.email===t?{...n,status:"error",statusicon:"‚ùå",info:((s=e.details[0])==null?void 0:s.message)??e.message}:n})})},resendWithError(){return this.reports=this.reports.map(t=>t.status==="error"?{...t,status:"sending",statusicon:"üì§",info:"Wird gesendet..."}:t),this.$api.post(`${this.id}/send-with-errors`).then(t=>{this.$panel.notification.success("E-Mails wurden erfolgreich versendet.");const e=t.data.newReports;this.reports=this.reports.map(n=>{const s=e.find(r=>r.email===n.email);return s?{...n,...s}:n})}).catch(t=>{console.error(t),this.$panel.notification.error(t),t.details&&(this.reports=this.reports.map(e=>{var s;return t.details.find(r=>r.label===e.email)?{...e,status:"error",statusicon:"‚ùå",info:((s=t.details[0])==null?void 0:s.message)??t.message}:e}))})}}};var y=function(){var e=this,n=e._self._c;return n("div",{staticStyle:{"margin-block":"2rem"}},[n("k-bar",[n("k-button-group",[n("k-button",{attrs:{variant:"filled",disabled:!e.canSendAll,icon:e.isSendingAll?"loader":"refresh"},on:{click:e.resendWithError}},[e._v(" Fehlgeschlagene E-Mails erneut senden ")])],1)],1),n("k-stats",{staticStyle:{"margin-top":"1rem"},attrs:{reports:[{value:e.successReportsLength||"0",label:"Erfolgreich",icon:"check",theme:"positive",info:e.errorReportsLength<=0&&"Alle E-Mails wurden erfolgreich zugestellt."},{value:e.errorReportsLength||"0",label:"Fehlgeschlagen",icon:"cancel",theme:"negative",info:e.errorReportsLength>0&&"Es gab Fehler beim Versenden der E-Mails."}]}}),n("div",{staticClass:"k-table",staticStyle:{"margin-top":"1rem"}},[n("table",[n("thead",[n("tr",[n("th",{staticClass:"k-table-index-column"},[e._v("#")]),n("th",{attrs:{"data-mobile":"true"}},[e._v("E-Mail")]),n("th",[e._v("Name")]),n("th",{staticClass:"k-dvll-nwsl-result-section-status-col",attrs:{"data-mobile":"true"}},[n("k-icon",{attrs:{type:"alert"}})],1),n("th",[e._v("Info")]),n("th",{attrs:{"data-mobile":"true"}},[e._v("Aktion")])])]),n("tbody",e._l(e.reports,function(s,r){return n("tr",{key:s.email},[n("td",{staticClass:"k-table-index-column"},[n("span",{staticClass:"k-table-index"},[e._v(e._s(r))])]),n("td",{attrs:{"data-mobile":"true"}},[e._v(e._s(s.email))]),n("td",[e._v(e._s(s.name))]),n("td",{staticClass:"k-dvll-nwsl-result-section-status-col",attrs:{"data-mobile":"true"}},[s.status==="error"?n("k-icon",{attrs:{type:"alert"}}):e._e()],1),n("td",{class:{"k-dvll-nwsl-result-section-error-text":s.status==="error"}},[e._v(e._s(s.info))]),n("td",{attrs:{"data-mobile":"true"}},[s.status==="error"?n("k-button",{attrs:{icon:"refresh","aria-label":`E-Mail erneut an ${s.email} senden`,title:`E-Mail erneut an '${s.email}' senden`,disabled:e.isSending},on:{click:function(o){return e.resendSingle(s.email)}}},[e._v("Erneut senden")]):e._e()],1)])}),0)])])],1)},E=[],L=d(w,y,E,!1,null,null,null,null);const T=L.exports;window.panel.plugin("getkirby/pluginkit",{components:{"k-newsletter-send-dialog":k},sections:{"newsletter-action":_,"newsletter-result":T}})})();
