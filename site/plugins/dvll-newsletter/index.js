(function(){"use strict";function l(t,e,n,s,o,d,c,k){var i=typeof t=="function"?t.options:t;e&&(i.render=e,i.staticRenderFns=n,i._compiled=!0),s&&(i.functional=!0),d&&(i._scopeId="data-v-"+d);var a;if(c?(a=function(r){r=r||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!r&&typeof __VUE_SSR_CONTEXT__<"u"&&(r=__VUE_SSR_CONTEXT__),o&&o.call(this,r),r&&r._registeredComponents&&r._registeredComponents.add(c)},i._ssrRegister=a):o&&(a=k?function(){o.call(this,(i.functional?this.parent:this).$root.$options.shadowRoot)}:o),a)if(i.functional){i._injectStyles=a;var T=i.render;i.render=function(y,h){return a.call(h),T(y,h)}}else{var u=i.beforeCreate;i.beforeCreate=u?[].concat(u,a):[a]}return{exports:t,options:i}}const p={data(){return{status:"loading",id:void 0,sendingTest:!1,errorDetailsList:[]}},computed:{allowedToSend(){return this.status==="draft"},canSend(){return this.allowedToSend},canSendTest(){return this.allowedToSend&&!this.sendingTest}},created(){this.load().then(t=>{this.status=t.status,this.id=t.id})},methods:{onSend(){if(this.$store.getters["content/hasChanges"]()){this.$panel.notification.error("Änderungen müssen vor dem Senden gespeichert oder verworfen werden.");return}this.$api.get(`${this.id}/check-send`).then(t=>{this.openDialog(t.data)}).catch(t=>{this.$panel.notification.error(t)})},openDialog(t=[]){this.$panel.dialog.open({component:"k-newsletter-send-dialog",props:{id:this.id,errorDetailsList:this.errorDetailsList,recipients:t.map(e=>({email:e.email,firstname:e.firstname,name:e.name})),canSubmit:t.length>0,text:"Den Newsletter an wirklich an alle Abonnenten senden?"},on:{submit:()=>{this.sendNewsletter()},close:()=>console.log("closed")}})},onSendTest(){if(this.$store.getters["content/hasChanges"]()){this.$panel.notification.error("Änderungen müssen vor dem Senden gespeichert oder verworfen werden.");return}this.sendTestNewsletter()},sendTestNewsletter(){if(!this.id){this.$panel.notification.error("Kein Newsletter zum versenden gefunden.");return}this.sendingTest=!0,this.$api.post(`${this.id}/send/1`).then(t=>{if(this.sendingTest=!1,t.data.successfulDelivery===0){this.$panel.notification.error("Keine Nachrichten versendet. Wurde mindestens ein Empfänger ausgewählt?");return}if(t.data.errorDelivery>0){this.$panel.notification.error("Beim Senden an einzelne Empfänger ist ein Problem aufgetreten.");return}this.$panel.notification.success("Testmail gesendet")}).catch(t=>{this.sendingTest=!1,console.error(t.message),this.$panel.notification.error(t)})},sendNewsletter(){if(!this.id){this.$panel.notification.error("No newsletter found");return}this.$panel.dialog.isLoading=!0,this.$api.post(`${this.id}/send`).then(t=>{if(this.$panel.dialog.isLoading=!1,t.data.successfulDelivery===0){this.$panel.notification.error("Keine Nachrichten versendet. Wurde mindestens ein Empfänger ausgewählt?");return}if(t.data.errorDelivery>0){this.$panel.notification.error("Beim Senden an einzelne Empfänger ist ein Problem aufgetreten.");return}this.$panel.dialog.close(),this.$panel.reload()}).catch(t=>{this.$panel.dialog.isLoading=!1,this.$panel.notification.error(t)})}}};var f=function(){var e=this,n=e._self._c;return n("section",{staticClass:"k-newsletter-action-section"},[n("k-bar",[n("k-button-group",[n("k-button",{attrs:{variant:"filled",disabled:!e.canSendTest,icon:e.sendingTest?"loader":"lab"},on:{click:e.onSendTest}},[e._v(" Testmail senden ")]),n("k-button",{attrs:{variant:"filled",disabled:!e.canSend,icon:"plane"},on:{click:e.onSend}},[e._v(" Newsletter versenden ")])],1)],1)],1)},g=[],m=l(p,f,g,!1,null,null,null,null);const _=m.exports,v={inheritAttrs:!1,props:{headline:{type:String,default:"Newsletter versenden"},size:{type:String,default:"medium"},id:{type:String},recipients:{type:Array,default:()=>[]},canSubmit:{type:Boolean,default:!1}},emits:["cancel","submit","success"],data(){return{canSubmit:!0,detailsOpen:!0,recipientPage:1,recipientPageLimit:10}},computed:{visibleRecipientsForPage(){const t=this.recipients.slice((this.recipientPage-1)*this.recipientPageLimit,this.recipientPage*this.recipientPageLimit);return this.recipientPage>1&&t.length<this.recipientPageLimit&&t.push(...Array(this.recipientPageLimit-t.length).fill({})),t},total(){return this.recipients.length},isLoading(){return this.$panel.dialog.isLoading},submitButton(){return{disabled:!this.canSubmit||this.$panel.dialog.isLoading,text:"Versenden",icon:"plane"}}},methods:{}};var $=function(){var e=this,n=e._self._c;return n("k-dialog",{attrs:{"cancel-button":"Nicht senden",size:e.size,"submit-button":e.submitButton,visible:!0},on:{cancel:function(s){return e.$emit("cancel")},submit:function(s){return e.$emit("submit")}}},[e.headline?n("k-headline",[e._v(" "+e._s(e.headline)+" ")]):e._e(),n("k-stats",{staticStyle:{"margin-top":"1rem"},attrs:{reports:[{value:e.recipients.length,label:"Empfänger",icon:"users"}]}}),n("k-text",{staticStyle:{"margin-top":"1rem"}},[e._v("Liste aller Empfänger:")]),n("div",{staticClass:"k-table",staticStyle:{"margin-top":"1rem"}},[n("table",[n("thead",[n("tr",[n("th",{attrs:{"data-mobile":"true"}},[e._v("E-Mail")]),n("th",{attrs:{"data-mobile":"true"}},[e._v("Name")])])]),n("tbody",e._l(e.visibleRecipientsForPage,function(s){return n("tr",{key:s.email},[n("td",{attrs:{"data-mobile":"true"}},[e._v(e._s(s.email))]),n("td",{attrs:{"data-mobile":"true"}},[e._v(e._s(s.firstname)+" "+e._s(s.name))])])}),0)])]),n("k-pagination",{staticStyle:{"margin-top":".5rem"},attrs:{page:e.recipientPage,total:e.total,details:!0,limit:e.recipientPageLimit},on:{paginate:function(s){e.recipientPage=s.page}}})],1)},b=[],S=l(v,$,b,!1,null,null,null,null);const w=S.exports;window.panel.plugin("getkirby/pluginkit",{components:{"k-newsletter-send-dialog":w},sections:{"newsletter-action":_}})})();
