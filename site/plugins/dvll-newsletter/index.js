(function(){"use strict";function d(n,e,t,i,r,o,c,N){var s=typeof n=="function"?n.options:n;e&&(s.render=e,s.staticRenderFns=t,s._compiled=!0),i&&(s.functional=!0),o&&(s._scopeId="data-v-"+o);var l;if(c?(l=function(a){a=a||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!a&&typeof __VUE_SSR_CONTEXT__<"u"&&(a=__VUE_SSR_CONTEXT__),r&&r.call(this,a),a&&a._registeredComponents&&a._registeredComponents.add(c)},s._ssrRegister=l):r&&(l=N?function(){r.call(this,(s.functional?this.parent:this).$root.$options.shadowRoot)}:r),l)if(s.functional){s._injectStyles=l;var R=s.render;s.render=function(E,h){return l.call(h),R(E,h)}}else{var u=s.beforeCreate;s.beforeCreate=u?[].concat(u,l):[l]}return{exports:n,options:s}}const p={data(){return{status:"loading",id:void 0,sendingTest:!1,errorDetailsList:[]}},computed:{allowedToSend(){return this.status==="draft"},canSend(){return this.allowedToSend},canSendTest(){return this.allowedToSend&&!this.sendingTest}},created(){this.load().then(n=>{this.status=n.status,this.id=n.id})},methods:{onSend(){if(this.$store.getters["content/hasChanges"]()){this.$panel.notification.error("√Ñnderungen m√ºssen vor dem Senden gespeichert oder verworfen werden.");return}this.$api.get(`${this.id}/check-send`).then(n=>{this.openDialog(n.data)}).catch(n=>{this.$panel.notification.error(n)})},openDialog(n=[]){this.$panel.dialog.open({component:"k-newsletter-send-dialog",props:{id:this.id,errorDetailsList:this.errorDetailsList,recipients:n.map(e=>({email:e.email,firstname:e.firstname,name:e.name})),canSubmit:n.length>0,text:"Den Newsletter an wirklich an alle Abonnenten senden?"},on:{submit:()=>{this.sendNewsletter()}}})},onSendTest(){if(this.$store.getters["content/hasChanges"]()){this.$panel.notification.error("√Ñnderungen m√ºssen vor dem Senden gespeichert oder verworfen werden.");return}this.sendTestNewsletter()},sendTestNewsletter(){if(!this.id){this.$panel.notification.error("Kein Newsletter zum versenden gefunden.");return}this.sendingTest=!0,this.$api.post(`${this.id}/send/1`).then(n=>{if(this.sendingTest=!1,n.data.successfulDelivery===0){this.$panel.notification.error("Keine Nachrichten versendet. Wurde mindestens ein Empf√§nger ausgew√§hlt?");return}if(n.data.errorDelivery>0){this.$panel.notification.error("Beim Senden an einzelne Empf√§nger ist ein Problem aufgetreten.");return}this.$panel.notification.success("Testmail gesendet")}).catch(n=>{this.sendingTest=!1,console.error(n),this.$panel.notification.error(n)})},sendNewsletter(){if(!this.id){this.$panel.notification.error("No newsletter found");return}this.$panel.dialog.isLoading=!0,this.$api.post(`${this.id}/send`).then(n=>{if(this.$panel.dialog.isLoading=!1,n.data.successfulDelivery===0){this.$panel.notification.error("Keine Nachrichten versendet. Wurde mindestens ein Empf√§nger ausgew√§hlt?");return}this.$panel.dialog.close(),this.$panel.reload()}).catch(n=>{this.$panel.dialog.isLoading=!1,console.error(n),this.$panel.notification.error(n)})}}};var f=function(){var e=this,t=e._self._c;return t("section",{staticClass:"k-newsletter-action-section"},[t("k-bar",[t("k-button-group",[t("k-button",{attrs:{variant:"filled",disabled:!e.canSendTest,icon:e.sendingTest?"loader":"lab"},on:{click:e.onSendTest}},[e._v(" Testmail senden ")]),t("k-button",{attrs:{variant:"filled",disabled:!e.canSend,icon:"plane"},on:{click:e.onSend}},[e._v(" Newsletter versenden ")])],1)],1)],1)},g=[],m=d(p,f,g,!1,null,null,null,null);const _=m.exports,v={inheritAttrs:!1,props:{headline:{type:String,default:"Newsletter versenden"},size:{type:String,default:"medium"},id:{type:String},recipients:{type:Array,default:()=>[]},canSubmit:{type:Boolean,default:!1}},emits:["cancel","submit","success"],data(){return{canSubmit:!0,detailsOpen:!0,recipientPage:1,recipientPageLimit:10}},computed:{visibleRecipientsForPage(){const n=this.recipients.slice((this.recipientPage-1)*this.recipientPageLimit,this.recipientPage*this.recipientPageLimit);return this.recipientPage>1&&n.length<this.recipientPageLimit&&n.push(...Array(this.recipientPageLimit-n.length).fill({})),n},total(){return this.recipients.length},isLoading(){return this.$panel.dialog.isLoading},submitButton(){return{disabled:!this.canSubmit||this.$panel.dialog.isLoading,text:"Versenden",icon:"plane"}}},methods:{}};var b=function(){var e=this,t=e._self._c;return t("k-dialog",{attrs:{"cancel-button":"Nicht senden",size:e.size,"submit-button":e.submitButton,visible:!0},on:{cancel:function(i){return e.$emit("cancel")},submit:function(i){return e.$emit("submit")}}},[e.headline?t("k-headline",[e._v(" "+e._s(e.headline)+" ")]):e._e(),t("k-stats",{staticStyle:{"margin-top":"1rem"},attrs:{reports:[{value:e.recipients.length,label:"Empf√§nger",icon:"users"}]}}),t("k-text",{staticStyle:{"margin-top":"1rem"}},[e._v("Liste aller Empf√§nger:")]),t("div",{staticClass:"k-table",staticStyle:{"margin-top":"1rem"}},[t("table",[t("thead",[t("tr",[t("th",{attrs:{"data-mobile":"true"}},[e._v("E-Mail")]),t("th",{attrs:{"data-mobile":"true"}},[e._v("Name")])])]),t("tbody",e._l(e.visibleRecipientsForPage,function(i){return t("tr",{key:i.email},[t("td",{attrs:{"data-mobile":"true"}},[e._v(e._s(i.email))]),t("td",{attrs:{"data-mobile":"true"}},[e._v(e._s(i.firstname)+" "+e._s(i.name))])])}),0)])]),t("k-pagination",{staticStyle:{"margin-top":".5rem"},attrs:{page:e.recipientPage,total:e.total,details:!0,limit:e.recipientPageLimit},on:{paginate:function(i){e.recipientPage=i.page}}})],1)},$=[],k=d(v,b,$,!1,null,null,null,null);const w=k.exports,S={data(){return{id:void 0,reports:[]}},computed:{errorReportsLength(){return this.reports.filter(n=>["error","sending"].includes(n.status)).length},successReportsLength(){return this.reports.filter(n=>n.status==="sent").length}},created(){this.load().then(n=>{this.reports=n.reports,this.id=n.id})},methods:{resendSingle(n){return this.reports=this.reports.map(e=>e.email===n?{...e,status:"sending",statusicon:"üì§",info:"Wird gesendet..."}:e),this.$api.post(`${this.id}/send-single`,{email:n}).then(e=>{this.$panel.notification.success(`E-Mail an '${n}'' wurde erfolgreich versendet.`);const{status:t,statusicon:i,info:r}=e.data;this.reports=this.reports.map(o=>o.email===n?{...o,status:t,statusicon:i,info:r}:o)}).catch(e=>{console.error(e),this.$panel.notification.error(e),this.reports=this.reports.map(t=>{var i;return t.email===n?{...t,status:"error",statusicon:"‚ùå",info:((i=e.details[0])==null?void 0:i.message)??e.message}:t})})}}};var y=function(){var e=this,t=e._self._c;return t("div",{staticStyle:{"margin-block":"2rem"}},[t("k-stats",{staticStyle:{"margin-top":"1rem"},attrs:{reports:[{value:e.successReportsLength||"0",label:"Erfolgreich",icon:"check",theme:"positive",info:e.errorReportsLength<=0&&"Alle E-Mails wurden erfolgreich zugestellt."},{value:e.errorReportsLength||"0",label:"Fehlgeschlagen",icon:"cancel",theme:"negative",info:e.errorReportsLength>0&&"Es gab Fehler beim Versenden der E-Mails."}]}}),t("div",{staticClass:"k-table",staticStyle:{"margin-top":"1rem"}},[t("table",[t("thead",[t("tr",[t("th",{staticClass:"k-table-index-column"},[e._v("#")]),t("th",{attrs:{"data-mobile":"true"}},[e._v("E-Mail")]),t("th",[e._v("Name")]),t("th",{staticClass:"k-dvll-nwsl-result-section-status-col",attrs:{"data-mobile":"true"}},[t("k-icon",{attrs:{type:"alert"}})],1),t("th",[e._v("Info")]),t("th",{attrs:{"data-mobile":"true"}},[e._v("Aktion")])])]),t("tbody",e._l(e.reports,function(i,r){return t("tr",{key:i.email},[t("td",{staticClass:"k-table-index-column"},[t("span",{staticClass:"k-table-index"},[e._v(e._s(r))])]),t("td",{attrs:{"data-mobile":"true"}},[e._v(e._s(i.email))]),t("td",[e._v(e._s(i.name))]),t("td",{staticClass:"k-dvll-nwsl-result-section-status-col",attrs:{"data-mobile":"true"}},[i.status==="error"?t("k-icon",{attrs:{type:"alert"}}):e._e()],1),t("td",{class:{"k-dvll-nwsl-result-section-error-text":i.status==="error"}},[e._v(e._s(i.info))]),t("td",{attrs:{"data-mobile":"true"}},[i.status==="error"?t("k-button",{attrs:{icon:"refresh","aria-label":`E-Mail erneut an ${i.email} senden`,title:`E-Mail erneut an '${i.email}' senden`},on:{click:function(o){return e.resendSingle(i.email)}}},[e._v("Erneut senden")]):e._e()],1)])}),0)])])],1)},L=[],T=d(S,y,L,!1,null,null,null,null);const C=T.exports;window.panel.plugin("getkirby/pluginkit",{components:{"k-newsletter-send-dialog":w},sections:{"newsletter-action":_,"newsletter-result":C}})})();
